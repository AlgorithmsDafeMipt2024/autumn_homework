# 6.2. Дерево отрезков. Обработка запросов от листьев. Обработка запросов от корня.

## Определение
Дерево отрезков (segment tree) — это структура данных, которая позволяет эффективно обрабатывать запросы на определение значения на отрезке (например, суммы, минимума, максимума) и изменения элементов массива.

---

## Построение дерева отрезков

### 1. Идея
1. Исходный массив \( A \) разбивается на отрезки, каждый из которых представлен узлом дерева.
2. Листья дерева содержат элементы массива \( A \).
3. Внутренние узлы дерева содержат результат агрегирующей функции для соответствующих подотрезков.

### 2. Агрегирующие функции
- Сумма элементов (\( \text{sum} \)).
- Минимум на отрезке (\( \text{min} \)).
- Максимум на отрезке (\( \text{max} \)).
- GCD, LCM и другие функции.

---

## Структура дерева отрезков

- Размер массива \( A \): \( n \).
- Размер дерева отрезков: \( 2 \cdot 2^{\lceil \log_2(n) \rceil} - 1 \) (или \( 4n \) для простоты реализации).

---

## Обработка запросов

### 1. Обработка запросов от листьев
- При изменении значения в одном из листьев (\( A[i] \)):
  1. Обновляется значение соответствующего узла.
  2. Значения всех узлов, лежащих на пути от этого листа к корню, пересчитываются.

- Сложность: \(\mathcal{O}(\log n)\).

### 2. Обработка запросов от корня
- Запросы, связанные с отрезками (\( [L, R] \)):
  1. Начинаем обработку от корня дерева.
  2. Если отрезок, соответствующий текущему узлу:
     - Полностью лежит внутри запроса (\([L, R]\)), возвращаем значение.
     - Не пересекается с запросом (\([L, R]\)), пропускаем узел.
     - Пересекается частично, продолжаем обработку для дочерних узлов.

- Сложность: \(\mathcal{O}(\log n)\).

---

## Пример

### Построение дерева для массива \( A = [1, 3, 5, 7, 9, 11] \)
- Дерево имеет глубину \( \lceil \log_2(6) \rceil = 3 \).
- Листья дерева содержат элементы \( A \).
- Внутренние узлы содержат сумму подотрезков:
  - Узел для диапазона \([0, 2]\) хранит \( 1 + 3 + 5 = 9 \).
  - Узел для диапазона \([3, 5]\) хранит \( 7 + 9 + 11 = 27 \).

---

## Сложность

- **Построение**:
  - \(\mathcal{O}(n)\), так как мы вычисляем значения для всех узлов один раз.
- **Обновление элемента**:
  - \(\mathcal{O}(\log n)\), так как обновляем только \( \log n \) узлов.
- **Запрос значения на отрезке**:
  - \(\mathcal{O}(\log n)\), так как спускаемся по дереву от корня.

---

## Заключение

Дерево отрезков — это мощная структура данных, которая позволяет эффективно решать задачи на отрезках при ограничениях:
- Массив не слишком велик (\( n \leq 10^5 \)).
- Часто требуется обрабатывать запросы изменения и получения данных.
Если массив динамически меняется, дерево отрезков превосходит по производительности такие структуры, как Sparse-Table.
